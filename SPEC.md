## 感情球体モデル 仕様書

**最終更新：2025年12月2日**

これは **HTML + Three.js で実装する感情球体 3D 可視化システム** の仕様書です。
ユーザーの内部感情状態（内部オーラ）と外部環境（外部オーラ）の相互作用を視覚化することを目的とします。

### 1. 概要

中央の「中心核」、6つの層を周回する19個の粒子（内部オーラ）、そして背景のパーティクルクラウド（外部オーラ）によって感情の動的な状態を表現します。

#### 1.1. 基本操作

-   **カメラ回転**: マウスドラッグ
-   **カメラズーム**: マウスホイール
-   **UIパネル開閉**: 画面下部のトグルボタン
-   **デバッグ情報表示**: 画面左上の「デバッグ表示/非表示」ボタン

### 2. 構成要素と仕様

#### 2.1. 内部オーラ (L5)

-   **役割**: ユーザー自身の内的な感情状態。
-   **視覚表現**: 中央の球体の周りを周回する多数の**粒子**。
-   **実装詳細**:
    -   粒子は6つの層に分かれて配置され、各層の境界は半透明の球体で可視化される。
    -   各粒子にはその感情名を示すラベルが表示される。
-   **状態（脳波/季節/天気）**:
    -   L5層の平均温度、平均ストレス、および温度の時間変化率から、「脳波（α/β/θ/δ）」「季節（春夏秋冬）」「天気（喜怒哀楽）」が**統一された単一のロジック**によって動的に決定される。
    -   UI上では、これらの状態が個別に、また組み合わせて表示される（例: 内部オーラ `秋・楽`、脳波状態 `θ波 (楽/秋)`）。
-   **粒子の挙動**:
    -   粒子の色は、内部オーラの「天気」(`internalAuraWeather`)によって決定され、温度に応じて輝度が変化する。
    -   各粒子は `drive`, `freeze`, `flow` の3タイプに分類され、それぞれ初期温度や他粒子への引力バイアスが異なる。
    -   ストレスは「基準軌道からのズレ」と「外部ストレス」で増加し、時間経過で自然に解放される。ストレス解放時に熱が発生する。
    -   温度は「ストレスによる発熱」「速度」「環境温度との差による冷却」で変動する。
    -   外部オーラから影響を受け、その状態を変化させます。

#### 2.2. 外部オーラ

#### 2.2. 光源 (Light Source) と創発重力 (Emergent Gravity)
* **役割:** 核層の中心に固定された**19番目の粒子**であり、感情システムの**創発重力場（$F_G$）の源泉**、および**熱力学的恒常性の調整弁**として機能する。
* **有効慣性質量 ($m_{\text{eff}}$):**
    * 光源の $m_{\text{eff}}$ は、全層の**平均情報エントロピー集中度 $\Gamma_{\text{avg}}$** に比例して動的に変動する。
        $$m_{\text{eff}} = G_{\text{MIN}} + K_{\text{RESPONSE}} \cdot \Gamma_{\text{avg}}$$
    * この $m_{\text{eff}}$ が、全層の粒子が中心に向かう創発重力場の強度を決定する。
* **熱源としての恒常性:**
    * 光源は、システムの**総ポテンシャル $S_{\text{Total}}$** が安定基準値 $\text{S}_{\text{Ref}}$ から逸脱する度合いに応じて、自身の温度 $\text{T}_{\text{Source}}$ を能動的に調整し、**システムを安定オーラ（「楽」）へ自己回帰させる熱源**として機能する。
        $$\text{T}_{\text{Source}} = \text{T}_{\text{Base}} + \text{K}_{\text{S}} \cdot (\text{S}_{\text{Total}} - \text{S}_{\text{Ref}})$$

#### 2.3. 外部オーラ

-   **役割**: ユーザーを取り巻く外部環境や他者からの影響。
-   **視覚表現**: 背景に表示される球状の**パーティクルクラウド**。
-   **状態**:
    -   **天気（感情）**: 外部環境の感情状態（例: 楽）。季節の概念はありません。
-   **挙動**:
    -   UIのボタン操作によって、環境温度 `T_env` と外部ストレス `globalExternalStress` が設定される。
    -   設定された外部ストレスは、時間経過と共に自然に減衰する (`* (1 - 2.5 * dt)`)。
    -   内部オーラ (L5) に対して影響を与えます。

#### 2.4. 相互作用

-   **影響の方向**: `外部オーラ → 内部オーラ (L5)` の**片方向**です。内部オーラが外部オーラに影響を与えることはありません。

### 3. UI（ユーザーインターフェース）

#### 3.0. 必須観測指標 (Academic Observation Metrics)

以下のDDD指標は、シミュレーションの**学術的な状態**を把握するためにUIに常時表示される**必須項目**とする。

1.  **平均 $\pi_n$ ($\text{Avg } \pi_n$):** $\pi_2$ から $\pi_7$ までの全層の動的安定定数の平均値。システムの**全体的な次元安定度**を示す。
2.  **支配的感情名 (Dominant Emotion):** **光源を除く18粒子**の中で、現在**ストレス $\sigma$** が最大値を持つ粒子の名称。感情システムの**現在の活性化傾向**を特定する。（※理論的には温度TまたはΓnだが、実装ではストレスを指標とする）
2.  **支配的感情名 (Dominant Emotion):** **光源を含む全19粒子**の中で、現在**温度 $T$** が最大値を持つ粒子の名称。感情システムの**現在の活性化傾向**を特定する。

#### 3.0.1. 視覚化要素

*   **感情粒子ラベル:** 全ての感情粒子（光源を除く18粒子）に対し、その**感情名（例: 悩、怒、楽）**を示すラベルを、Three.js の 3D 空間に追従して表示する。

---


#### 3.1. デバッグ情報パネル

-   **機能**:
    -   システムの詳細な物理演算データや状態変数をリアルタイムで表示します。
    -   アコーディオン形式の開閉ボタン（例: 「デバッグ情報」）でパネルの表示・非表示を切り替えます。
-   **表示項目**:
    -   核輝度、磁気質量
    -   総ポテンシャル(S₇)
    -   平均温度、平均ストレス
    -   πn平均 (安定性)
    -   支配的感情
    -   外部/内部オーラの天気
    -   その他、`globalParams` の主要な値（`pi_n_by_layer`, `rho_n_by_layer`, `Gamma_n_by_layer` など）

#### 3.2. 外部オーラ操作パネル

-   **天気（感情）設定ボタン**:
    -   「喜」「怒」「哀」「楽」などのボタンを配置します。
    -   ボタンを押すと、即座に外部オーラ（雲）の状態が対応する天気に変更され、その状態が維持されます。
-   **「外部オーラ無し」ボタン**:
    -   外部オーラの視覚表現である**パーティクルクラウドの表示・非表示**を切り替えます。
    -   このボタンは周回する粒子（内部オーラ）の表示には影響しません。

#### 3.3. AIパラメータ入力パネル

-   **機能**:
    -   TOON形式のテキストを入力し、「パラメータをシミュレーションに適用」ボタンを押すことで、シミュレーションをリセットし、新しいパラメータで再開する。
-   **入力パラメータ**:
    -   `T_activity_avg`: 全粒子の初期温度に適用
    -   `M_inertia_avg`: 全粒子の基本質量に適用
    -   `S_load_avg`: 全粒子の初期ストレスに適用

### 4. 物理モデルと計算（理論）

（このセクションは、理論的な目標として `SPEC.md` の旧バージョンから引き継ぎ、実装の指針とします）

#### 4.1. 層別動的次元力学

* **ポテンシャル $S_n$ の連鎖構造:** 各層のポテンシャル $S_n$ は、内側の層 $S_{n-1}$ のポテンシャルを継承し、新しい層のポテンシャル $\Delta S_n$ が加算される**階層的連鎖構造**を採用する。
    $$
    S_n = S_{n-1} + \Delta S_n
    $$
    （例: $S_3 = S_2 + 3c, S_4 = S_3 + 3d, \dots$）
* **$\pi_n$ の確定式:** 動的安定定数 $\pi_n$ は、以下の連分数近似構造を持つ。
    $$\pi_n = \frac{22S_n + 3b}{7S_n + b}$$
    （ここで $b$ は層エネルギーの基本平均値、全層共通の定数として機能する。）
システムのコアロジックは、層ごとに定義された以下の数式に基づいて計算されます。
マスター制御変数は **Γₙ = ln(1 + ρₙ)** です。

| 層              | n | πₙ（確定式）          | Vₙ（半径=1）           | ρₙ     |
| --------------- | - | ----------------------- | ----------------------- | -------- |
| L0 核層         | 2 | (22S₂ + 3b)/(7S₂ + b) | π₂                    | π₂ / 4 |
| L1 身体層       | 3 | (22S₃ + 3b)/(7S₃ + b) | π₃^(3/2)/(1.5√π)    | V₃ / 9  |
| L2 思考層       | 4 | (22S₄ + 3b)/(7S₄ + b) | π₄² / 2              | V₄ / 16 |
| L3 文明層       | 5 | (22S₅ + 3b)/(7S₅ + b) | π₅^(5/2)/(3.75√π)   | V₅ / 25 |
| L4 外部接合層   | 6 | (22S₆ + 3b)/(7S₆ + b) | π₆³ / 6              | V₆ / 36 |
| L5 外部雰囲気層 | 7 | (22S₇ + 3b)/(7S₇ + b) | π₇^(7/2)/(52.5√π/4) | V₇ / 49 |

#### 4.2. 粒子への物理作用
-   **次元曲率力 (Fₚᵢₙ)**: 層ごとの `π_local` (`globalParams.pi_n_by_layer[layerIdx]`) を用いて計算します。
-   **創発重力**: `G_eff ∝ globalParams.Gamma_n_by_layer[this.layer]` として実装します。
-   **量子ゆらぎ**: `jitter ∝ 1 / globalParams.Gamma_n_by_layer[this.layer]` として実装します。

#### 4.2.1. 光源 (Light Source) コアロジックの確定
*   **有効慣性質量 ($m_{\text{eff}}$):** 全層の平均 $\Gamma_{\text{avg}}$ に連動する。
    $$m_{\text{eff}} = G_{\text{MIN}} + K_{\text{RESPONSE}} \cdot \Gamma_{\text{avg}}$$
*   **恒常性温度 ($\text{T}_{\text{Source}}$) の計算:** 総ポテンシャル $S_{\text{Total}}$ に基づき能動的に調整される。
    $$\text{T}_{\text{Source}} = \text{T}_{\text{Base}} + \text{K}_{\text{S}} \cdot (\text{S}_{\text{Total}} - \text{S}_{\text{Ref}})$$

#### 4.3. 可逆的熱伝導 (Reversible Thermal Conduction)

熱（T）と応力（$\sigma$）の伝導は、全て**層の平均値**を介した双方向の勾配伝導として実行される。

* **基本原理:** 熱エネルギーの伝達は、層の境界を越えて、常に**温度の高い領域から低い領域へ**と流れる**双方向（可逆的）伝導**である。これは、外部環境からの影響が核の意志（光源）にフィードバックされ、核の熱が外部へ伝播するという、**感情のダイナミクス**を表現する。
* **伝導構造:**
    1.  **L0 粒子 $\leftrightarrow$ 光源:** 核層粒子は光源の $\text{T}_{\text{Source}}$ と熱交換する。
        $$\Delta \text{T}_{\text{L0}} = \text{K}_{\text{Cond}} \cdot (\text{T}_{\text{Source}} - \text{T}_{\text{L0}})$$
    2.  **$L_n$ 粒子 $\leftrightarrow$ $L_{n-1}$ 層:** 外層 $L_n$ の粒子は、**内側層 $L_{n-1}$ の平均温度 $\text{T}_{\text{avg}, n-1}$** と熱交換する（$n=1 \dots 5$）。
        $$\Delta \text{T}_{\text{Ln}} = \text{K}_{\text{Cond}} \cdot (\text{T}_{\text{avg}, n-1} - \text{T}_{\text{Ln}})$$
    3.  **$L_5$ 粒子 $\leftrightarrow$ 外部オーラ:** 最外層 $L_5$ の粒子は、内側 $L_4$ 層に加え、**外部オーラの環境温度 $\text{T}_{\text{Env}}$** とも熱交換する。
        $$\Delta \text{T}_{\text{L5, Env}} = \text{K}_{\text{Env}} \cdot (\text{T}_{\text{Env}} - \text{T}_{\text{L5}})$$

#### 4.4. 可逆的応力伝導 (Reversible Stress Conduction)

1.  **応力伝導 ($\Delta \sigma$):**
    *   **L0粒子 $\leftrightarrow$ 光源:** 光源の基準応力 $\sigma_{\text{Source}}$（極めて低い値）を参照する。$\Delta \sigma = \text{K}_{\sigma \text{Cond}} \cdot (\sigma_{\text{Source}} - \sigma_{\text{L0}})$
    *   **$L_n$ 粒子 $\leftrightarrow$ $L_{n-1}$ 層:** $\Delta \sigma_{\text{Inner}} = \text{K}_{\sigma \text{Cond}} \cdot (\sigma_{\text{avg}, n-1} - \sigma_{\text{Ln}})$
    *   **$L_5$ 粒子 $\leftrightarrow$ 外部オーラ:** 外部環境応力 $\sigma_{\text{Env}}$ の影響も受ける。$\Delta \sigma_{\text{Env}} = \text{K}_{\sigma \text{Env}} \cdot (\sigma_{\text{Env}} - \sigma_{\text{L5}})$

---

## 今後の対応タスク（設計書準拠）

`design.md` との機能差分を埋めるための主要な開発タスクです。
- [ ] **高度な視覚フィードバックの実装:**
  - [ ] L5層の温度変化率に基づいた「感情の季節」判定ロジックを実装する。
  - [ ] 76種以上の「感情名称」を動的に生成するロジックを実装する。
